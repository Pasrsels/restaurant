{% extends "base.html" %}
{% load static %}
{% block title %}Cash Ups{% endblock title %}
{% block content %}

<div class="container-fluid" style="height: 100;">
    <div class="row" style="height: 25;">
        <div>
            <span class="mt-2 fs-5">Inventory Budgets</span>
        </div>
        <div>
            <nav class="d-flex justify-content-end align-items-center rounded mb-2 py-2 border-bottom">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <a href="{% url 'inventory:create-budget' %}" class="btn btn-outline-dark btn-lg w-100" type="button" aria-expanded="false" style="min-width: 150px;">Create Budget</a>
                    </div>
                    <div class="me-3">
                        <div class="dropdown">
                            <button class="btn btn-outline-dark btn-lg dropdown-toggle w-100" type="button" id="generateByButton" data-bs-toggle="dropdown" aria-expanded="false" style="min-width: 150px;">
                                Generate By
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="generateByButton">
                                <li><a class="dropdown-item" href="#" onclick="generateReport('daily')">Daily</a></li>
                                <li><a class="dropdown-item" href="#" onclick="generateReport('weekly')">Weekly</a></li>
                                <li><a class="dropdown-item" href="#" onclick="generateReport('monthly')">Monthly</a></li>
                                <li><a class="dropdown-item" href="#" onclick="generateReport('yearly')">Yearly</a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="row g-2">
                        <div class="col-md-2 mb-2">
                            <label for="adminInventory" class="form-label fw-bold">Admin</label>
                            <input type="text" id="adminInventory" class="form-control" value="$0.00" disabled>
                        </div>

                        <div class="col-md-2 mb-2">
                            <label for="inventory" class="form-label fw-bold">Inventory</label>
                            <input type="text" id="inventory" class="form-control" value="$0.00" disabled>
                        </div>

                        <div class="col-md-2 mb-2">
                            <label for="operating" class="form-label fw-bold">Operating</label>
                            <input type="text" id="operating" class="form-control" value="$0.00" disabled>
                        </div>

                        <div class="col-md-2 mb-2">
                            <label for="others" class="form-label fw-bold">Others</label>
                            <input type="text" id="others" class="form-control" value="$0.00" disabled>
                        </div>

                        <div class="col-md-2 mb-2">
                            <label for="total" class="form-label fw-bold">Total</label>
                            <input type="text" id="total" class="form-control" value="$0.00" disabled>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </div>    
    <div class="row" style="height: 75; overflow-y: auto;">
        <div class="table-responsive mt-4">
            <table class="table table-hover table-striped" id="Budget2_table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Projected</th>
                        <th>Approved</th>
                        <th>Actual</th>
                        <th>Difference</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

        
    <!--budget View Modal -->
    <div class="modal fade" id="budgetViewModal" tabindex="-1" aria-labelledby="budgetViewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="budgetViewModalLabel">Budget View</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between mb-3">
                        <div><strong>Total Amount:</strong> <span id="totalAmount">$0.00</span></div>
                        <div><strong>Budget Name:</strong> <span id="budgetName">Sample Budget</span></div>
                    </div>
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Amount</th>
                                <th>Amount Approved</th>
                            </tr>
                        </thead>
                        <tbody id="budgetItemsTableBody">
                            <!-- dynamically populate rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="budgetConfirmModal" tabindex="-1" aria-labelledby="budgetConfirmModalLabel" aria-hidden="true">    
        <div class="modal-dialog modal-lg">        
            <div class="modal-content">            
                <div class="modal-header">                
                    <h5 class="modal-title" id="budgetConfirmModalLabel">Budget View</h5>                
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>            
                </div>            
                <div class="modal-body">                
                    <div><strong>Budget Name:</strong> <span id="budgetConfirmName">Sample Budget</span></div>                    
                    <div class="d-flex justify-content-between mb-3">                        
                        <div><strong>Total Amount:</strong> <span id="ConfirmtotalAmount">$0.00</span></div>                        
                        <div><strong>Approved Total Amount:</strong> <span id="amountApproved">$0.00</span></div>                        
                        <div><strong>Difference:</strong> <span id="difference">$0.00</span></div>               
                    </div>                  
                    <table class="table table-bordered">                    
                        <thead class="table-light">                        
                            <tr>                            
                                <th>Product</th>                            
                                <th>Quantity</th>                            
                                <th>Amount Declared <sup>1</sup></th>                            
                                <th>Amount Approved <sup>2</sup></th>                        
                            </tr>                    
                        </thead>                    
                        <tbody id="ConfirmsbudgetItemsTableBody">                                          
                        </tbody>                
                    </table>                
                    <div class="mt-3 d-flex align-items-center">                    
                        <label for="note" class="me-2"><strong>NOTE:</strong></label>                    
                        <input type="text" id="note" class="form-control" placeholder="Enter note if 1 and 2 are not '=='" />                
                    </div>            
                </div>        
            </div>    
        </div> 
    </div>
</div>

<script>
    function generateReport(period) {
            console.log('Generating report for:', period);
            const url = "{% url 'inventory:estimations'%}";
            fetch(url,{
                method: 'GET',
                headers: {
                    'ContentType': 'application/json',
                    'X-CSRFToken': getCookie('csrf_token')
                },
            }).then(response => response.json())
            .then(data =>{
                if(data.success){
                    console.log(data.combined_list)
                }
            })

            // call an API to update values based on the selection    
        }    
    function updateCategoryValues(adminInventory, inventory, operating) {
            // Update the textboxes with the respective values
            document.getElementsByName('admin')[0].value = `admin`;
            document.getElementsByName('inventory')[1].value = `inventory`;
            document.getElementsByName('operating')[2].value = `operating`;
            document.getElementsByName('others')[3].value = `others`;

            const total = admin + inventory + operating + others;
            document.getElementById('total').value = `$${total.toFixed(2)}`;
        }
    async function fetchCategories() {
        const tableBody = document.querySelector("#Budget2_table tbody");
        tableBody.innerHTML = "";

        try {
            const response = await fetch("{%url 'inventory:budget-approval'%}");
            const data = await response.json(); 

            Object.keys(data).forEach(category => {
                const dropdownRow = `
                    <tr class="category-header">
                        <td colspan="7">
                            <button class="btn btn-link" onclick="toggleCategoryRows('${category}')">
                                ${category} <span class="dropdown-icon">+</span>
                            </button>
                        </td>
                        <td>
                            <i class="btn btn-sm btn-success bx bx-play" onclick="approveCategory('${category}')" title="Approve Category"></i>
                            <i class="btn btn-sm btn-primary bx bx-pencil" onclick="editCategory('${category}')" title="Edit Category"></i>
                            <i class="btn btn-sm btn-danger bx bx-trash" onclick="deleteCategory('${category}')" title="Delete Category"></i>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML("beforeend", dropdownRow);

                budgetData[category] = data[category];
            });
        } catch (error) {
            console.error("Error fetching categories:", error);
        }
    }

    function toggleCategoryRows(category) {
        const tableBody = document.querySelector("#Budget2_table tbody");
        const existingRows = document.querySelectorAll(`.category-${category}`);

        if (existingRows.length > 0) {
            existingRows.forEach(row => row.remove());
        } else {
            const rows = budgetData[category].map(item => `
                <tr class="category-${category}">
                    <td></td>
                    <td>${item.date}</td>
                    <td>${item.name}</td>
                    <td>${item.projected.toFixed(2)}</td>
                    <td>${item.approved.toFixed(2)}</td>
                    <td>${item.actual.toFixed(2)}</td>
                    <td>${(item.projected - item.actual).toFixed(2)}</td>
                    <td>
                        <i class="btn btn-sm btn-success bi bi-play-circle-fill" onclick="approveItem('${category}', ${item.id})" title="Approve Item"></i>
                        <i class="btn btn-sm btn-primary bi bi-pencil-square" onclick="editItem('${category}', ${item.id})" title="Edit Item"></i>
                        <i class="btn btn-sm btn-danger bi bi-trash" onclick="deleteItem('${category}', ${item.id})" title="Delete Item"></i>
                    </td>
                </tr>
            `).join("");

            tableBody.insertAdjacentHTML("beforeend", rows);
        }
    }

    async function approveCategory(category, budgetInfo) {
    try {
        const data = {
            Save: 'all',
            budget_info:[budget_id, category_name, budget_item_id]
        };

        const response = await fetch("{% url 'inventory:budget-approval' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken(), 
            },
            body: JSON.stringify(data),
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                alert(`Category "${category}" approved successfully!`);
            } else {
                alert("Error: Unable to approve category. Please try again.");
            }
        } else {
            console.error("Error approving category:", response.statusText);
            alert("Failed to approve category. Please try again later.");
        }
    } catch (error) {
        console.error("Error:", error);
        alert("An error occurred while approving the category. Please try again.");
    }
}

async function approveItem(category, id, approvedAmount) {
    try {
        const data = {
            Save: 'single', 
            budget_item_id: id, 
            approoved_amount: approvedAmount 
        };

        const response = await fetch("{% url 'inventory:budget-approval' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken(), 
            },
            body: JSON.stringify(data),
        });

        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                alert(`Item in category "${category}" approved successfully!`);
            } else {
                alert("Error: Unable to approve item. Please try again.");
            }
        } else {
            console.error("Error approving item:", response.statusText);
            alert("Failed to approve item. Please try again later.");
        }
    } catch (error) {
        console.error("Error:", error);
        alert("An error occurred while approving the item. Please try again.");
    }
}

    /*
    async function editCategory(category) {
        const newCategoryName = prompt(`Enter a new name for category "${category}":`);
        if (newCategoryName) {
            try {
                const response = await fetch(`/api/`, { //edit category
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name: newCategoryName })
                });
                if (response.ok) {
                    alert(`Category "${category}" updated successfully!`);
                    fetchCategories();
                } else {
                    console.error("Error editing category:", response.statusText);
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }
    }
    
    async function editItem(category, id) {
        const newItemName = prompt(`Enter a new name for item with ID "${id}":`);
        if (newItemName) {
            try {
                const response = await fetch(`/api/`, { //edit item
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name: newItemName })
                });
                if (response.ok) {
                    alert(`Item "${id}" updated successfully!`);
                    toggleCategoryRows(category); 
                } else {
                    console.error("Error editing item:", response.statusText);
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }
    }
        */

        async function deleteCategory(category) {
    if (confirm(`Are you sure you want to delete all items in the category "${category}"?`)) {
        try {
            const data = {
                budget_id:budget_id,
                category: category_name, 
                action: "delete_all" 
            };

            const response = await fetch("{% url 'inventory:budget' %}", {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken(), 
                },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    alert(`All items in category "${category}" deleted successfully!`);
                    fetchCategories(); 
                } else {
                    alert("Error: Unable to delete category. Please try again.");
                }
            } else {
                console.error("Error deleting category:", response.statusText);
                alert("Failed to delete category. Please try again later.");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("An error occurred while deleting the category. Please try again.");
        }
    }
}

async function deleteItem(category, id) {
    if (confirm(`Are you sure you want to delete item in category "${category}"?`)) {
        try {
            const data = {
                budget_id,
                budget_item_id: id, 
                action: "delete_item" 
            };

            const response = await fetch("{% url 'inventory:budget' %}", {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken(), 
                },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    alert(`Item deleted successfully!`);
                    toggleCategoryRows(category); 
                } else {
                    alert("Error: Unable to delete item. Please try again.");
                }
            } else {
                console.error("Error deleting item:", response.statusText);
                alert("Failed to delete item. Please try again later.");
            }
        } catch (error) {
            console.error("Error:", error);
            alert("An error occurred while deleting the item. Please try again.");
        }
    }
}

    document.addEventListener("DOMContentLoaded", fetchCategories);

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
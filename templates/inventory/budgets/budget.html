{% extends "base.html" %}
{% load static %}
{% block title %}Cash Ups{% endblock title %}
{% block content %}

<div class="container mt-4">
    <div class="row align-items-center">
        <div class="col-md-3 mb-3">
            <div class="dropdown">
                <button class="btn btn-primary btn-lg dropdown-toggle w-100" type="button" id="generateByButton" data-bs-toggle="dropdown" aria-expanded="false">
                    Generate By
                </button>
                <ul class="dropdown-menu" aria-labelledby="generateByButton">
                    <li><a class="dropdown-item" href="#" onclick="generateReport('daily')">Daily</a></li>
                    <li><a class="dropdown-item" href="#" onclick="generateReport('weekly')">Weekly</a></li>
                    <li><a class="dropdown-item" href="#" onclick="generateReport('monthly')">Monthly</a></li>
                    <li><a class="dropdown-item" href="#" onclick="generateReport('yearly')">Yearly</a></li>
                </ul>
            </div>
        </div>

        <div class="col-md-9">
            <div class="row">

                <div class="col-md-2 mb-2">
                    <label for="adminInventory" class="form-label fw-bold">Admin</label>
                    <input type="text" id="adminInventory" class="form-control" value="$0.00" disabled>
                </div>

                <div class="col-md-2 mb-2">
                    <label for="inventory" class="form-label fw-bold">Inventory</label>
                    <input type="text" id="inventory" class="form-control" value="$0.00" disabled>
                </div>

                <div class="col-md-2 mb-2">
                    <label for="operating" class="form-label fw-bold">Operating</label>
                    <input type="text" id="operating" class="form-control" value="$0.00" disabled>
                </div>

                <div class="col-md-2 mb-2">
                    <label for="others" class="form-label fw-bold">Others</label>
                    <input type="text" id="others" class="form-control" value="$0.00" disabled>
                </div>

                <div class="col-md-2 mb-2">
                    <label for="total" class="form-label fw-bold">Total</label>
                    <input type="text" id="total" class="form-control" value="$0.00" disabled>
                </div>
            </div>
        </div>
    </div>
</div>


<div>
    <nav class="d-flex justify-content-between align-items-center rounded mb-2 py-2 border-bottom">
        <div>
            <span class='mt-2 fs-5'>Inventory Budgets</span>
        </div>
        <div class="d-flex justify-content-between mt-1">
            <ul class="list-unstyled d-flex">
                <li>
                    <a href="{% url 'inventory:create-budget' %}" class="btn btn-outline-dark mx-2">Create Budget</a>
                </li>
            </ul>
        </div>
    </nav>
    
    <div class="table-responsive">
       <table class="table table-hover table-striped" id="Budget2_table">
            <thead>
                    <tr>
                        <th>Category</th>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Projected</th>
                        <th>Approved</th>
                        <th>Actual</th>
                        <th>Difference</th>
                        <th>Actions</th>
                     </tr>
                </thead>
                <tbody>
                        <!-- Rows will be dynamically added here -->
                </tbody>
            </table>
        </div>
    </div>
        

    <!--budget View Modal -->
    <div class="modal fade" id="budgetViewModal" tabindex="-1" aria-labelledby="budgetViewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="budgetViewModalLabel">Budget View</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between mb-3">
                        <div><strong>Total Amount:</strong> <span id="totalAmount">$0.00</span></div>
                        <div><strong>Budget Name:</strong> <span id="budgetName">Sample Budget</span></div>
                    </div>
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Amount</th>
                                <th>Amount Approved</th>
                            </tr>
                        </thead>
                        <tbody id="budgetItemsTableBody">
                            <!-- dynamically populate rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="budgetConfirmModal" tabindex="-1" aria-labelledby="budgetConfirmModalLabel" aria-hidden="true">    
        <div class="modal-dialog modal-lg">        
            <div class="modal-content">            
                <div class="modal-header">                
                    <h5 class="modal-title" id="budgetConfirmModalLabel">Budget View</h5>                
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>            
                </div>            
                <div class="modal-body">                
                    <div><strong>Budget Name:</strong> <span id="budgetConfirmName">Sample Budget</span></div>                    
                    <div class="d-flex justify-content-between mb-3">                        
                        <div><strong>Total Amount:</strong> <span id="ConfirmtotalAmount">$0.00</span></div>                        
                        <div><strong>Approved Total Amount:</strong> <span id="amountApproved">$0.00</span></div>                        
                        <div><strong>Difference:</strong> <span id="difference">$0.00</span></div>               
                    </div>                  
                    <table class="table table-bordered">                    
                        <thead class="table-light">                        
                            <tr>                            
                                <th>Product</th>                            
                                <th>Quantity</th>                            
                                <th>Amount Declared <sup>1</sup></th>                            
                                <th>Amount Approved <sup>2</sup></th>                        
                            </tr>                    
                        </thead>                    
                        <tbody id="ConfirmsbudgetItemsTableBody">                                          
                        </tbody>                
                    </table>                
                    <div class="mt-3 d-flex align-items-center">                    
                        <label for="note" class="me-2"><strong>NOTE:</strong></label>                    
                        <input type="text" id="note" class="form-control" placeholder="Enter note if 1 and 2 are not '=='" />                
                    </div>            
                </div>        
            </div>    
        </div> 
    </div>
</div>

<script>
 function generateReport(period) {
        console.log('Generating report for:', period);
        // call an API to update values based on the selection    
    }    
    function updateCategoryValues(adminInventory, inventory, operating) {
        // Update the textboxes with the respective values
        document.getElementById('admin').value = ``;
        document.getElementById('inventory').value = ``;
        document.getElementById('operating').value = ``;
        document.getElementById('others').value = ``;
        const total = admin + inventory + operating + others;
        document.getElementById('total').value = `$${total.toFixed(2)}`;
    }
async function fetchCategories() {
    const tableBody = document.querySelector("#Budget2_table tbody");
    tableBody.innerHTML = "";

    try {
        const response = await fetch("/api/");
        const data = await response.json(); 

        Object.keys(data).forEach(category => {
            const dropdownRow = `
                <tr class="category-header">
                    <td colspan="7">
                        <button class="btn btn-link" onclick="toggleCategoryRows('${category}')">
                            ${category} <span class="dropdown-icon">+</span>
                        </button>
                    </td>
                    <td>
                        <i class="btn btn-sm btn-success bi bi-play-circle-fill" onclick="approveCategory('${category}')" title="Approve Category"></i>
                        <i class="btn btn-sm btn-primary bi bi-pencil-square" onclick="editCategory('${category}')" title="Edit Category"></i>
                        <i class="btn btn-sm btn-danger bi bi-trash" onclick="deleteCategory('${category}')" title="Delete Category"></i>
                    </td>
                </tr>
            `;
            tableBody.insertAdjacentHTML("beforeend", dropdownRow);

            budgetData[category] = data[category];
        });
    } catch (error) {
        console.error("Error fetching categories:", error);
    }
}

function toggleCategoryRows(category) {
    const tableBody = document.querySelector("#Budget2_table tbody");
    const existingRows = document.querySelectorAll(`.category-${category}`);

    if (existingRows.length > 0) {
        existingRows.forEach(row => row.remove());
    } else {
        const rows = budgetData[category].map(item => `
            <tr class="category-${category}">
                <td></td>
                <td>${item.date}</td>
                <td>${item.name}</td>
                <td>${item.projected.toFixed(2)}</td>
                <td>${item.approved.toFixed(2)}</td>
                <td>${item.actual.toFixed(2)}</td>
                <td>${(item.projected - item.actual).toFixed(2)}</td>
                <td>
                    <i class="btn btn-sm btn-success bi bi-play-circle-fill" onclick="approveItem('${category}', ${item.id})" title="Approve Item"></i>
                    <i class="btn btn-sm btn-primary bi bi-pencil-square" onclick="editItem('${category}', ${item.id})" title="Edit Item"></i>
                    <i class="btn btn-sm btn-danger bi bi-trash" onclick="deleteItem('${category}', ${item.id})" title="Delete Item"></i>
                </td>
            </tr>
        `).join("");

        tableBody.insertAdjacentHTML("beforeend", rows);
    }
}

async function approveCategory(category) {
    try {
        const response = await fetch(`/api/`, { //approve whole category
            method: "POST"
        });
        if (response.ok) {
            alert(`Category "${category}" approved successfully!`);
        } else {
            console.error("Error approving category:", response.statusText);
        }
    } catch (error) {
        console.error("Error:", error);
    }
}

async function approveItem(category, id) {
    try {
        const response = await fetch(`/api/`, { //approve one product or expense
            method: "POST"
        });
        if (response.ok) {
            alert(`Item approved successfully!`);
        } else {
            console.error("Error approving item:", response.statusText);
        }
    } catch (error) {
        console.error("Error:", error);
    }
}

async function editCategory(category) {
    const newCategoryName = prompt(`Enter a new name for category "${category}":`);
    if (newCategoryName) {
        try {
            const response = await fetch(`/api/`, { //edit category
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: newCategoryName })
            });
            if (response.ok) {
                alert(`Category "${category}" updated successfully!`);
                fetchCategories();
            } else {
                console.error("Error editing category:", response.statusText);
            }
        } catch (error) {
            console.error("Error:", error);
        }
    }
}

async function editItem(category, id) {
    const newItemName = prompt(`Enter a new name for item with ID "${id}":`);
    if (newItemName) {
        try {
            const response = await fetch(`/api/`, { //edit item
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: newItemName })
            });
            if (response.ok) {
                alert(`Item "${id}" updated successfully!`);
                toggleCategoryRows(category); 
            } else {
                console.error("Error editing item:", response.statusText);
            }
        } catch (error) {
            console.error("Error:", error);
        }
    }
}

async function deleteCategory(category) {
    if (confirm(`Are you sure you want to delete category "${category}"?`)) {
        try {
            const response = await fetch(`/api/`, { //delete category
                method: "DELETE"
            });
            if (response.ok) {
                alert(`Category deleted successfully!`);
                fetchCategories(); 
            } else {
                console.error("Error deleting category:", response.statusText);
            }
        } catch (error) {
            console.error("Error:", error);
        }
    }
}

async function deleteItem(category, id) {
    if (confirm(`Are you sure you want to delete item "${id}"?`)) {
        try {
            const response = await fetch(`/api/`, { //delete item
                method: "DELETE"
            });
            if (response.ok) {
                alert(`Item deleted successfully!`);
                toggleCategoryRows(category);
            } else {
                console.error("Error deleting item:", response.statusText);
            }
        } catch (error) {
            console.error("Error:", error);
        }
    }
}

document.addEventListener("DOMContentLoaded", fetchCategories);

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
</script>
{% endblock %}